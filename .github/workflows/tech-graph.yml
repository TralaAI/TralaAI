name: 🌐 Generate Polyglot Tech-Graph

permissions:
  contents: write   # allow updating the repo

on:
  schedule:
    - cron: '0 3 * * *'   # nightly at 03:00 UTC
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout main repo into workspace root (so .git is here)
      - uses: actions/checkout@v3

      # 2) Checkout other TralaAI repos as subfolders
      - name: Checkout blazor-ui
        uses: actions/checkout@v3
        with:
          repository: TralaAI/blazor-ui
          path: blazor-ui

      - name: Checkout core-api
        uses: actions/checkout@v3
        with:
          repository: TralaAI/core-api
          path: core-api

      - name: Checkout fastapi
        uses: actions/checkout@v3
        with:
          repository: TralaAI/fastapi
          path: fastapi

      - name: Checkout model-trainer
        uses: actions/checkout@v3
        with:
          repository: TralaAI/model-trainer
          path: model-trainer

      # 3) Install Python & mermaid-cli
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install mermaid-cli
        run: npm install -g @mermaid-js/mermaid-cli

      # 4) Run the scanner to emit a .mmd file
      - name: Generate Mermaid definition
        run: |
          python3 scripts/scan-tech.py > tech-graph.mmd

      # 5) Render the Mermaid file to SVG (disable sandbox for Puppeteer)
      - name: Render SVG
        run: |
          npx mmdc \
            -i tech-graph.mmd \
            -o tech-graph.svg \
            --no-sandbox \
            --puppeteerConfig '{"args":["--no-sandbox","--disable-setuid-sandbox"]}'

      # 6) Commit & push the result
      - name: Commit & push tech-graph.svg
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: 📈 update polyglot tech graph"
          file_pattern: tech-graph.svg
          token: ${{ secrets.GITHUB_TOKEN }}
