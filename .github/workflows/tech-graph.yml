# File: .github/workflows/tech-graph.yml
name: ðŸ“ˆ Tech-Graph

on:
  schedule:
    - cron: '0 3 * * *'    # nightly at 03:00 UTC
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout the main TralaAI/TralaAI repo into ./root
      - name: Check out TralaAI/TralaAI
        uses: actions/checkout@v3
        with:
          repository: TralaAI/TralaAI
          path: root

      # 2) Checkout each of the other org repos into its own folder
      - name: Check out TralaAI/blazor-ui
        uses: actions/checkout@v3
        with:
          repository: TralaAI/blazor-ui
          path: blazor-ui

      - name: Check out TralaAI/core-api
        uses: actions/checkout@v3
        with:
          repository: TralaAI/core-api
          path: core-api

      - name: Check out TralaAI/fastapi
        uses: actions/checkout@v3
        with:
          repository: TralaAI/fastapi
          path: fastapi

      - name: Check out TralaAI/model-trainer
        uses: actions/checkout@v3
        with:
          repository: TralaAI/model-trainer
          path: model-trainer

      # 3) Install Graphviz and dependency-cruiser
      - name: Install Graphviz & Dependency-Cruiser
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz
          npm install -g dependency-cruiser --unsafe-perm

      # 4) Generate the combined .dot
      - name: Generate combined DOT
        run: |
          depcruise \
            root \
            blazor-ui \
            core-api \
            fastapi \
            model-trainer \
            --no-config \
            --output-type dot \
            > tech-graph.dot

      # 5) Render the SVG
      - name: Render SVG
        run: |
          dot -Tsvg tech-graph.dot -o tech-graph.svg

      # 6) Commit & push it back
      - name: Commit & push tech-graph.svg
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: ðŸ“ˆ update tech graph"
          file_pattern: tech-graph.svg
