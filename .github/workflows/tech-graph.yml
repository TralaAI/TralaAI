# File: .github/workflows/tech-graph.yml
name: ðŸ“ˆ Tech-Graph

on:
  schedule:
    - cron: '0 3 * * *'    # nightly at 03:00 UTC
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - repo: TralaAI/TralaAI
            path: root
          - repo: TralaAI/blazor-ui
            path: blazor-ui
          - repo: TralaAI/core-api
            path: core-api
          - repo: TralaAI/fastapi
            path: fastapi
          - repo: TralaAI/model-trainer
            path: model-trainer

    steps:
      - name: Check out ${{ matrix.repo }}
        uses: actions/checkout@v3
        with:
          repository: ${{ matrix.repo }}
          path: ${{ matrix.path }}

      - name: Install Dependency-Cruiser & Graphviz
        if: matrix.path == 'root'
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz
          npm install -g dependency-cruiser --unsafe-perm

      - name: Generate combined DOT
        if: matrix.path == 'root'
        run: |
          depcruise \
            root \
            blazor-ui \
            core-api \
            fastapi \
            model-trainer \
            --no-config \
            --output-type dot \
            > tech-graph.dot

      - name: Render SVG
        if: matrix.path == 'root'
        run: dot -Tsvg tech-graph.dot -o tech-graph.svg

      - name: Commit & push tech-graph.svg
        if: matrix.path == 'root'
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: ðŸ“ˆ update org-wide tech graph"
          file_pattern: tech-graph.svg
