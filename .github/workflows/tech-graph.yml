# File: .github/workflows/tech-graph.yml
name: ðŸ“ˆ Tech-Graph

permissions:
  contents: write
  
on:
  schedule:
    - cron: '0 3 * * *'    # nightly at 03:00 UTC
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout main repo into the workspace (default)
      - name: Check out TralaAI/TralaAI
        uses: actions/checkout@v3

      # 2) Checkout other org repos into subfolders
      - name: Check out blazor-ui
        uses: actions/checkout@v3
        with:
          repository: TralaAI/blazor-ui
          path: blazor-ui

      - name: Check out core-api
        uses: actions/checkout@v3
        with:
          repository: TralaAI/core-api
          path: core-api

      - name: Check out fastapi
        uses: actions/checkout@v3
        with:
          repository: TralaAI/fastapi
          path: fastapi

      - name: Check out model-trainer
        uses: actions/checkout@v3
        with:
          repository: TralaAI/model-trainer
          path: model-trainer

      # 3) Install Graphviz & dependency-cruiser
      - name: Install Graphviz & Dependency-Cruiser
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz
          npm install -g dependency-cruiser --unsafe-perm

      # 4) Generate the combined .dot (scan the workspace root plus subfolders)
      - name: Generate combined DOT
        run: |
          depcruise \
            . \
            blazor-ui \
            core-api \
            fastapi \
            model-trainer \
            --no-config \
            --output-type dot \
            > tech-graph.dot

      # 5) Render the SVG
      - name: Render SVG
        run: dot -Tsvg tech-graph.dot -o tech-graph.svg

      # 6) Commit & push tech-graph.svg back into TralaAI/TralaAI
      - name: Commit & push tech-graph.svg
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: ðŸ“ˆ update org-wide tech graph"
          file_pattern: tech-graph.svg
